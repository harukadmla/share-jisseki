# オーナーアカウント設定ガイド

## 🏗️ セットアップ手順

### 1. SQLマイグレーションの実行

#### 1.1 基本認証システムのセットアップ
1. Supabase ダッシュボード > SQL Editor
2. `/supabase/migrations/002_auth_system_fixed.sql` の内容を実行

#### 1.2 オーナー機能の追加
1. Supabase ダッシュボード > SQL Editor  
2. `/supabase/migrations/003_owner_setup.sql` の内容を実行

### 2. オーナーアカウントの作成

#### 2.1 サインアップ
1. アプリケーションで `/auth/signup` にアクセス
2. 以下の情報で登録：
   - **表示名**: オーナー
   - **メールアドレス**: `harukadmla@gmail.com`
   - **パスワード**: `Pw321321`
   - **権限**: 管理者

#### 2.2 オーナー権限の設定
Supabase SQL Editor で以下を実行:
```sql
SELECT public.setup_owner_account();
```

### 3. メール認証設定

#### 3.1 Supabaseの設定
1. Authentication > Providers > Email
2. **「Enable Email Confirmations」を OFF にする**
3. Save をクリック

#### 3.2 ユーザー登録の有効化
1. Authentication > Settings
2. **「Allow new users to sign up」を ON にする**
3. Save をクリック

## 🔧 システムの動作

### アカウント申請フロー

1. **新規ユーザーが登録申請**
   - `/auth/signup` でアカウント作成申請
   - 「アカウント作成の申請完了。オーナーより許可が出るまでお待ちください。」メッセージ表示

2. **オーナーにメール通知**
   - `harukadmla@gmail.com` に承認依頼メールが送信
   - メールには「承認する」「拒否する」ボタンが含まれる

3. **オーナーが承認/拒否**
   - メールのボタンクリックで即座に処理
   - 処理結果ページが表示

4. **ユーザーがログイン**
   - 承認されたユーザーのみログイン可能
   - 拒否されたユーザーはログイン不可

### 権限システム

- **オーナー**: すべての権限（削除・編集・承認）
- **管理者**: 削除・編集権限、新規ユーザー承認権限  
- **ユーザー**: 編集権限のみ

## 📧 メール送信の設定（オプション）

### 開発環境
- メールはコンソールログに出力
- 承認リンクもログで確認可能

### 本番環境（Resend使用）
1. [Resend](https://resend.com) でAPIキーを取得
2. `.env.local` に追加:
   ```
   RESEND_API_KEY=re_xxxxxxxxxxxxx
   ```
3. 送信者ドメインを設定

## 🧪 テスト手順

### 1. オーナーログインテスト
```
Email: harukadmla@gmail.com
Password: Pw321321
```

### 2. 新規ユーザー申請テスト
1. 別のメールアドレスでサインアップ
2. 申請完了メッセージを確認
3. コンソールログで承認リンクを確認
4. リンクをクリックして承認
5. そのアカウントでログインテスト

## 🔍 トラブルシューティング

### SQLエラーの場合
- テーブルが既に存在する場合は、SQLの`DROP TABLE`部分を確認

### メールが送信されない場合  
- コンソールログでリンクを確認
- デバッグ用のリンクが返されるかチェック

### ログインできない場合
- プロファイルの`status`が`approved`になっているか確認:
  ```sql
  SELECT * FROM profiles WHERE email = 'your_email@example.com';
  ```

### 承認リンクが機能しない場合
- トークンの有効期限（7日）を確認
- `approval_notifications`テーブルでトークンの状態確認

## 📱 実運用時の推奨設定

1. **本番用SMTP設定**: ResendやSendGridを設定
2. **ドメイン設定**: 適切なドメインからメール送信
3. **セキュリティ**: Row Level Securityポリシーの見直し
4. **バックアップ**: データベースの定期バックアップ

## 🚀 デプロイ後の確認項目

- [ ] オーナーアカウントでログイン可能
- [ ] 新規ユーザー登録で申請完了メッセージ表示
- [ ] メール送信（またはログ出力）確認
- [ ] 承認リンクの動作確認
- [ ] 権限による機能制限の確認