# イベント実績分析ツール - 機能要件書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**Event Performance Analyzer** (イベント実績分析ツール)
携帯ショップ外販イベント実績分析システム

### 1.2 目的
携帯ショップの外販イベントにおける実績データの効率的な入力、管理、分析を行うためのWebアプリケーション

### 1.3 技術スタック
- **フロントエンド**: Next.js 14.2.5 + React 18.3.1 + TypeScript
- **バックエンド**: Next.js API Routes + Supabase
- **データベース**: Supabase (PostgreSQL) + Prisma (SQLite - 開発用)
- **認証**: Supabase Auth
- **ストレージ**: Supabase Storage
- **UI**: Tailwind CSS + Lucide React Icons
- **フォーム**: React Hook Form + Zod validation
- **チャート**: Recharts

## 2. ユーザー管理・認証システム

### 2.1 ユーザーロール
- **Owner (オーナー)**: 全機能アクセス可能、ユーザー承認権限
- **Admin (管理者)**: データ管理、ユーザー承認権限
- **User (一般ユーザー)**: データ入力・閲覧権限

### 2.2 認証フロー
1. **ログイン機能** (`/page.tsx`)
   - メールアドレス・パスワード認証
   - Supabaseでの認証処理
   - プロファイル自動作成機能
   - オーナー自動判定 (harukadmla@gmail.com)
   - 承認ステータス確認

2. **ユーザー登録** (`/auth/signup/page.tsx`)
   - 新規アカウント作成
   - プロファイル作成と承認申請

3. **ユーザー承認システム**
   - 管理者による新規ユーザー承認
   - 承認待ち・承認済み・拒否ステータス管理

### 2.3 プロファイル管理
- ユーザーID、表示名、メールアドレス
- ロール・ステータス管理
- 承認日時・承認者記録

## 3. データ入力機能

### 3.1 メイン入力フォーム (`/input/page.tsx`)
**EnhancedPerformanceFormV2** コンポーネントによる包括的な実績入力

#### 3.1.1 イベント基本情報
- **会場**: 文字列 (必須)
- **代理店名**: 文字列 (必須)
- **開始日・終了日**: 日付選択 (必須)
- **年・月・週番号**: 自動計算

#### 3.1.2 目標数値設定
- **HS（新規）合計目標**: 数値
- **au MNP目標**: 数値
- **UQ MNP目標**: 数値
- **au 新規目標**: 数値
- **UQ 新規目標**: 数値

#### 3.1.3 運営詳細情報
- **応援人数**: 各日の参加者数
- **実働時間**: 各日の稼働時間
- **天候情報**: 各日の天気状況
- **店舗混雑度**: 各日の混雑レベル
- **備考**: 自由記述

#### 3.1.4 スタッフ実績入力
各スタッフの日別詳細実績:

**新規ID系数値**:
- au MNP (SP1, SP2, SIM)
- UQ MNP (SP1, SP2, SIM) 
- au HS (SP1, SP2, SIM)
- UQ HS (SP1, SP2, SIM)
- セルアップ (SP1, SP2, SIM)

**LTV系数値**:
- クレジットカード
- ゴールドカード
- じぶん銀行口座
- 保証
- OTT
- 電気・ガス

**その他**:
- NW件数

#### 3.1.5 写真添付機能
- イベント写真最大5枚まで添付可能
- Supabase Storageへの保存

### 3.2 フォーム機能
- **動的スタッフ追加・削除**
- **日別実績コピー機能**
- **リアルタイムバリデーション** (Zod)
- **計算値自動表示** (合計値など)
- **段階的フォーム展開** (アコーディオンUI)

### 3.3 データ保存処理
- FormData + JSON形式でのAPI送信
- 複数テーブルへの同時保存
- 写真ファイル処理とURL生成
- エラーハンドリングと成功時リダイレクト

## 4. データ閲覧機能

### 4.1 実績一覧表示 (`/view/page.tsx`)
**PerformanceListV2** コンポーネント

#### 4.1.1 一覧機能
- イベント別実績カード表示
- 基本情報表示 (会場、代理店、期間)
- 目標達成状況の可視化
- 個人実績サマリー

#### 4.1.2 フィルタリング・ソート
- 期間指定フィルタ
- 代理店別フィルタ
- 達成率別ソート

### 4.2 詳細表示 (`/view/[eventId]/page.tsx`)
個別イベントの詳細情報

#### 4.2.1 表示内容
- イベント基本情報
- 目標vs実績対比
- 日別実績推移
- スタッフ別実績詳細
- 運営状況詳細
- 添付写真ギャラリー

## 5. 分析機能

### 5.1 実績分析ダッシュボード (`/analytics/page.tsx`)
**PerformanceAnalyticsV2** コンポーネント

#### 5.1.1 分析種別
- **月次分析**: 月別実績推移
- **エリア分析**: 代理店・会場別比較
- **実績レベル分析**: 高・中・低実績イベント分類
- **スタッフ分析**: 個人実績比較

#### 5.1.2 可視化機能
- 棒グラフ・折れ線グラフ (Recharts)
- 円グラフによる構成比表示
- ヒートマップ表示
- KPIサマリーカード

#### 5.1.3 データ抽出機能
- 期間指定での絞り込み
- 条件別データ抽出
- CSV エクスポート (予定)

### 5.2 分析指標
- 目標達成率
- 新規ID獲得数推移
- LTV系商材契約数
- スタッフ効率性指標
- イベント規模別実績比較

## 6. 管理機能

### 6.1 管理者ダッシュボード (`/admin/page.tsx`)
#### 6.1.1 ユーザー承認機能
- 承認申請一覧表示
- 承認・拒否処理
- ユーザーロール管理

#### 6.1.2 システム管理
- データベース整合性チェック
- バックアップ機能 (予定)

### 6.2 ユーザー管理 (`/admin/users/page.tsx`)
- 全ユーザー一覧
- ロール変更機能
- アカウント有効化・無効化

## 7. API設計

### 7.1 認証関連API
- `POST /api/auth/login`: ログイン処理
- `POST /api/auth/logout`: ログアウト処理
- `POST /api/setup-owner`: オーナーアカウント初期設定
- `POST /api/auth/send-approval-email`: 承認メール送信

### 7.2 実績データAPI
- `POST /api/performances/enhanced-v2`: 実績データ保存
- `GET /api/performances`: 実績データ一覧取得
- `GET /api/events/[eventId]`: 個別イベント詳細取得
- `GET /api/analytics`: 分析データ取得

### 7.3 管理機能API
- `GET /api/admin/users`: ユーザー一覧取得
- `POST /api/admin/approval`: ユーザー承認処理

## 8. データベース設計

### 8.1 Supabase テーブル構成
#### events テーブル
- 基本情報: venue, agency_name, start_date, end_date
- メタ情報: year, month, week_number
- 作成・更新日時

#### event_performances テーブル  
- イベントID参照
- 目標値各種
- 実績集計値各種
- 運営詳細情報

#### staff_performances テーブル
- スタッフ名・イベント参照
- 日別詳細実績

#### profiles テーブル
- ユーザー基本情報
- ロール・ステータス管理

### 8.2 Prisma スキーマ (開発用)
- Event, Performance, Closer, EventCloser モデル
- リレーションシップ定義

## 9. UI/UX設計

### 9.1 デザインシステム
- **カラーテーマ**: プライマリー (青)、サクセス (緑)、ワーニング (オレンジ)
- **コンポーネント**: モダンなグラスモーフィズムデザイン
- **レスポンシブ**: モバイル・タブレット・デスクトップ対応

### 9.2 ナビゲーション
- **メインナビゲーション**: 実績入力・閲覧・分析
- **条件付きナビゲーション**: ユーザーロール別表示制御
- **ブレッドクラム**: ページ階層表示

### 9.3 フォームUX
- **段階的入力**: アコーディオンによる情報整理
- **リアルタイム validation**: エラー即座表示
- **プログレス表示**: 入力進捗の可視化

## 10. セキュリティ要件

### 10.1 認証・認可
- Supabase Row Level Security (RLS) 実装
- セッション管理とタイムアウト
- CSRF 対策

### 10.2 データ保護
- 環境変数による機密情報管理
- API キー・データベース接続文字列の暗号化
- ファイルアップロード時のセキュリティチェック

## 11. パフォーマンス要件

### 11.1 レスポンス時間
- ページロード: 2秒以内
- API レスポンス: 1秒以内
- ファイルアップロード: プログレス表示

### 11.2 最適化
- Next.js の SSG/ISR 活用
- 画像最適化
- コード分割とレイジーローディング

## 12. 運用・保守要件

### 12.1 ログ・監視
- エラーログ記録
- パフォーマンス監視
- ユーザー操作ログ

### 12.2 バックアップ
- データベース定期バックアップ
- ファイルストレージバックアップ
- 復旧手順書作成

## 13. 今後の拡張予定

### 13.1 機能拡張
- レポート自動生成
- メール通知機能
- モバイルアプリ対応

### 13.2 分析機能強化
- AI による実績予測
- 異常値検知
- ベンチマーク機能

## 14. 制約事項・前提条件

### 14.1 技術制約
- ブラウザサポート: モダンブラウザのみ
- JavaScript 必須
- インターネット接続必須

### 14.2 運用制約  
- 同時接続ユーザー数上限
- ファイルサイズ制限
- データ保存期間